var CbLiveSearchInstances=[];function hideAllCbLiveSearch(e){for(var t=0;t<CbLiveSearchInstances.length;t++){var l=CbLiveSearchInstances[t];e!==l&&(l.hideList(),l.list.selectManualSelection())}}function createCbLiveSearchSkeleton(){var e=document.createElement("input");return e.type="text",e.classList.add("cb-livesearch"),e}function createCbLiveSearchListSkeleton(i){var s=document.createElement("div");s.className="cb-livesearch-list",s.setPosition=function(e){s.style.left=e.offsetLeft+"px",s.style.top=e.offsetTop+e.offsetHeight+"px",s.style.width=e.offsetWidth+"px"};var e=document.createElement("table");e.className="cb-livesearch-list-table",s.appendChild(e);var n=e.createTBody();s.tbody=n;var t=document.createElement("div");return t.className="cb-livesearch-message-box",s.appendChild(t),s.messageBox=t,s.addItem=function(t,l){var n=s.tbody.rows.length,e=s.tbody.insertRow(n),i=e.insertCell(0);e.detail={html:t,id:l,rowIndex:n},i.innerHTML=t,e.addEventListener("click",function(e){s.itemSelected(t,l,n)})},s.itemSelected=function(e,t,l){var n=new CustomEvent("itemselected",{detail:{html:e,id:t,rowIndex:l}});s.manualSelection=l,s.changeManualSelection(),s.dispatchEvent(n),i.hideList()},s.manualSelection=-1,s.manualSelectPrior=function(){s.manualSelection--,s.manualSelection<0&&(s.manualSelection=s.tbody.rows.length-1),s.changeManualSelection()},s.manualSelectNext=function(){s.manualSelection++,s.manualSelection>=s.tbody.rows.length&&(s.manualSelection=0<s.tbody.rows.length?0:-1),s.changeManualSelection()},s.scrollToRow=function(e){var t=e.offsetTop,l=s.scrollTop,n=s.scrollTop+s.offsetHeight;t<l?s.scrollTop=t:t+e.offsetHeight>n&&(s.scrollTop=t-(s.offsetHeight-e.offsetHeight))},s.changeManualSelection=function(){for(var e=n.getElementsByClassName("selection"),t=0;t<e.length;t++){e[t].classList.remove("selection")}if(-1!=s.manualSelection){var l=s.tbody.rows[s.manualSelection];l.classList.add("selection"),s.scrollToRow(l)}},s.clearManualSelection=function(){s.manualSelection=-1,s.changeManualSelection()},s.getSelectedItem=function(){return-1==s.manualSelection?null:s.tbody.rows[s.manualSelection].detail},s.selectManualSelection=function(){var e=null;-1!=s.manualSelection&&(e=s.tbody.rows[s.manualSelection].detail),i.setValue(e)},s.selectValue=function(e){if(-1!=s.manualSelection&&null!=e&&s.tbody.rows[s.manualSelection].detail.id==e.id){var t=s.tbody.rows[s.manualSelection];return void s.scrollToRow(t)}if(null!=e){for(var l=0;l<s.tbody.rows.length;l++){if(s.manualSelection=-1,s.tbody.rows[l].detail.id==e.id){s.manualSelection=l;break}}-1==s.manualSelection&&(s.addItem(e.html,e.id),s.manualSelection=s.tbody.rows.length-1),s.changeManualSelection()}else s.clearManualSelection()},s.clear=function(){for(var e=s.tbody.rows.length-1;0<=e;e--)s.tbody.deleteRow(e);s.clearManualSelection()},s}function CbLiveSearch(e,t){var n=this;CbLiveSearchInstances.push(this),this.html2text=function(e){if(null==e)return e;var t=document.createElement("div");return t.innerHTML=e,t.innerText},this.fillItems=!0===t,this.input=e||createCbLiveSearchSkeleton(),this.input.setAttribute("autocomplete","off"),this.input.classList.add("cb-livesearch-input"),this.inputClickListener=this.input.addEventListener("click",function(e){hideAllCbLiveSearch(n),e.preventDefault(),e.stopPropagation()}),this.inputFocusListener=this.input.addEventListener("focus",function(){n.showList()}),this.list=createCbLiveSearchListSkeleton(this),this.list.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation()}),this.inputKeyDownListener=this.input.addEventListener("keydown",function(e){switch(n.showList(),e.keyCode){case 38:n.list.manualSelectPrior();break;case 40:n.list.manualSelectNext();break;case 13:var t=n.list.getSelectedItem();null!=t&&n.list.itemSelected(t.html,t.id,t.rowIndex);break;case 9:n.list.selectManualSelection(),n.hideList()}}),this.searchDelay=300,this.search=function(t){void 0===t&&(t=!1),null!=n.timerCallback&&clearTimeout(n.timerCallback);var l=n.getText();n.timerCallback=setTimeout(function(){if(null!=n.sourceCallback){var e;n.lastSearch=l,n.requestId++,n.timerCallback=null,t&&(e=n.getText,n.getText=function(){return""});try{n.sourceCallback(function(e){if(e.requestId==n.requestId){n.list.clear();for(var t=0;t<e.records.length;t++)n.list.addItem(e.records[t].html,e.records[t].id);0!=e.records.length&&0!=l.trim().length&&n.list.manualSelectNext(),n.showOrHideEmptyText()}},n)}finally{t&&(n.getText=e)}}},n.searchDelay)},this.inputKeyUpListener=this.input.addEventListener("keyup",function(e){(32==e.keyCode||46==e.keyCode||48<=e.keyCode&&e.keyCode<=90||96<=e.keyCode&&e.keyCode<=111||186<=e.keyCode&&e.keyCode<=222||8==e.keyCode)&&n.search()}),this.requestId=0,this.showList=function(){if(!n.showingList){var e=n.input.parentElement||document.body;n.showingList=!0,e.style.position="relative",e.appendChild(n.list),n.list.setPosition(n.input),n.list.style.display="inline-block",n.list.selectValue(n.getValue()),0==n.list.tbody.rows.length&&n.search(),setTimeout(function(){n.list.classList.add("show")},60),setTimeout(function(){},120)}},this.hideList=function(){n.showingList&&(n.showingList=!1,n.list.classList.remove("show"),setTimeout(function(){var e=n.list.parentElement;null!=e&&e.removeChild(n.list)},50))},this.list.addEventListener("itemselected",function(e){n.setValue(e.detail)}),this.setValue=function(e,t){if(e===n.selectedValue||null!=e&&null!=n.selectedValue&&e.id==n.selectedValue.id)null!=n.selectedValue?n.input.value=n.html2text(n.selectedValue.html):n.input.value="";else{if(null!=e){if(null==e.html||null==e.id)throw new Error('Value must have fields "html" and "id".');n.selectedValue=e,n.input.value=n.html2text(e.html)}else n.selectedValue=null,n.input.value=null;if(n.list.selectValue(e),t||void 0===t){var l=null;null!=e&&(l={html:e.html,id:e.id,rowIndex:e.rowIndex}),n.input.dispatchEvent(new CustomEvent("valuechange",{detail:l}))}}},this.getValue=function(){return null==this.selectedValue?null:{id:this.selectedValue.id,html:this.selectedValue.html}},this.getText=function(){return n.input.value},this.setSourceCallback=function(e){n.sourceCallback=e,n.fillItems&&n.search(!0)},this.setEmptyText=function(e){n.emptyText=e},this.showOrHideEmptyText=function(){0==n.list.tbody.rows.length?(n.list.messageBox.innerText=n.emptyText||"",n.list.messageBox.classList.add("show")):n.list.messageBox.classList.remove("show")},this.clear=function(){n.list.clear(),n.setValue(null)},this.destroy=function(){e.classList.remove("cb-livesearch"),e.removeEventListener("click",n.inputClickListener),e.removeEventListener("focus",n.inputFocusListener),e.removeEventListener("keydown",n.inputKeyDownListener),e.removeEventListener("keyup",n.inputKeyUpListener),CbLiveSearchInstances.remove(n)}}function createOfflineDataSource(o){return!o instanceof Array?(console.error("Not a array: "+JSON.stringify(o)),null):function(e,t){for(var l=t.getText().trim().toLowerCase(),n=document.createElement("div"),i=[],s=0;s<o.length;s++){var a=o[s];if(null!=a.html)if(null!=a.id)n.innerHTML=o[s].html,-1!=n.innerText.trim().toLowerCase().indexOf(l)&&i.push(a);else console.warn('Record has no "id" field.');else console.warn('Record has no "html" field.')}e({requestId:t.requestId,records:i})}}document.addEventListener("click",function(){hideAllCbLiveSearch()});
