var CbLiveSearchInstances=[];function hideAllCbLiveSearch(e){for(var t=0;t<CbLiveSearchInstances.length;t++){var l=CbLiveSearchInstances[t];e!==l&&(l.hideList(),l.list.selectManualSelection())}}function createCbLiveSearchSkeleton(){var e=document.createElement("input");return e.type="text",e.classList.add("cb-livesearch"),e}function createCbLiveSearchListSkeleton(n){var s=document.createElement("div");s.className="cb-livesearch-list",s.setPosition=function(e){s.style.left=e.offsetLeft+"px",s.style.top=e.offsetTop+e.offsetHeight+"px",s.style.width=e.offsetWidth+"px"};var e=document.createElement("table");e.className="cb-livesearch-list-table",s.appendChild(e);var i=e.createTBody();s.tbody=i;var t=document.createElement("div");return t.className="cb-livesearch-message-box",s.appendChild(t),s.messageBox=t,s.addItem=function(t,l){var i=s.tbody.rows.length,e=s.tbody.insertRow(i),n=e.insertCell(0);e.detail={html:t,id:l,rowIndex:i},n.innerHTML=t,e.addEventListener("click",function(e){s.itemSelected(t,l,i)})},s.itemSelected=function(e,t,l){var i=new CustomEvent("itemselected",{detail:{html:e,id:t,rowIndex:l}});s.manualSelection=l,s.changeManualSelection(),s.dispatchEvent(i),n.hideList()},s.manualSelection=-1,s.manualSelectPrior=function(){s.manualSelection--,s.manualSelection<0&&(s.manualSelection=s.tbody.rows.length-1),s.changeManualSelection()},s.manualSelectNext=function(){s.manualSelection++,s.manualSelection>=s.tbody.rows.length&&(s.manualSelection=0<s.tbody.rows.length?0:-1),s.changeManualSelection()},s.scrollToRow=function(e){var t=e.offsetTop,l=s.scrollTop,i=s.scrollTop+s.offsetHeight;t<l?s.scrollTop=t:t+e.offsetHeight>i&&(s.scrollTop=t-(s.offsetHeight-e.offsetHeight))},s.changeManualSelection=function(){for(var e=i.getElementsByClassName("selection"),t=0;t<e.length;t++){e[t].classList.remove("selection")}if(-1!=s.manualSelection){var l=s.tbody.rows[s.manualSelection];l.classList.add("selection"),s.scrollToRow(l)}},s.clearManualSelection=function(){s.manualSelection=-1,s.changeManualSelection()},s.getSelectedItem=function(){return-1==s.manualSelection?null:s.tbody.rows[s.manualSelection].detail},s.selectManualSelection=function(){var e=null;-1!=s.manualSelection&&(e=s.tbody.rows[s.manualSelection].detail),n.setValue(e)},s.selectValue=function(e){if(-1!=s.manualSelection&&null!=e&&s.tbody.rows[s.manualSelection].detail.id==e.id){var t=s.tbody.rows[s.manualSelection];return void s.scrollToRow(t)}if(null!=e){for(var l=0;l<s.tbody.rows.length;l++){if(s.manualSelection=-1,s.tbody.rows[l].detail.id==e.id){s.manualSelection=l;break}}-1==s.manualSelection&&(s.addItem(e.html,e.id),s.manualSelection=s.tbody.rows.length-1),s.changeManualSelection()}else s.clearManualSelection()},s.clear=function(){for(var e=s.tbody.rows.length-1;0<=e;e--)s.tbody.deleteRow(e);s.clearManualSelection()},s}function CbLiveSearch(e,t){var i=this;CbLiveSearchInstances.push(this),this.html2text=function(e){if(null==e)return e;var t=document.createElement("div");return t.innerHTML=e,t.innerText},this.fillItems=!0===t,this.input=e||createCbLiveSearchSkeleton(),this.input.setAttribute("autocomplete","off"),this.input.classList.add("cb-livesearch-input"),this.inputClickListener=this.input.addEventListener("click",function(e){hideAllCbLiveSearch(i),e.preventDefault(),e.stopPropagation()}),this.inputFocusListener=this.input.addEventListener("focus",function(){i.showList()}),this.list=createCbLiveSearchListSkeleton(this),this.list.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation()}),this.inputKeyDownListener=this.input.addEventListener("keydown",function(e){switch(i.showList(),e.keyCode){case 38:i.list.manualSelectPrior();break;case 40:i.list.manualSelectNext();break;case 13:var t=i.list.getSelectedItem();null!=t&&i.list.itemSelected(t.html,t.id,t.rowIndex);break;case 9:i.list.selectManualSelection(),i.hideList()}}),this.search=function(t){void 0===t&&(t=!1),null!=i.timerCallback&&clearTimeout(i.timerCallback);var l=i.getText();i.timerCallback=setTimeout(function(){if(null!=i.sourceCallback){var e;i.lastSearch=l,i.requestId++,i.timerCallback=null,t&&(e=i.getText,i.getText=function(){return""});try{i.sourceCallback(function(e){if(e.requestId==i.requestId){i.list.clear();for(var t=0;t<e.records.length;t++)i.list.addItem(e.records[t].html,e.records[t].id);0!=e.records.length&&0!=l.trim().length&&i.list.manualSelectNext(),i.showOrHideEmptyText()}},i)}finally{t&&(i.getText=e)}}},300)},this.inputKeyUpListener=this.input.addEventListener("keyup",function(e){(32==e.keyCode||46==e.keyCode||48<=e.keyCode&&e.keyCode<=90||96<=e.keyCode&&e.keyCode<=111||186<=e.keyCode&&e.keyCode<=222||8==e.keyCode)&&i.search()}),this.requestId=0,this.showList=function(){if(!i.showingList){var e=i.input.parentElement||document.body;i.showingList=!0,e.style.position="relative",e.appendChild(i.list),i.list.setPosition(i.input),i.list.style.display="inline-block",i.list.selectValue(i.getValue()),0==i.list.tbody.rows.length&&i.search(),setTimeout(function(){i.list.classList.add("show")},60),setTimeout(function(){},120)}},this.hideList=function(){i.showingList&&(i.showingList=!1,i.list.classList.remove("show"),setTimeout(function(){var e=i.list.parentElement;null!=e&&e.removeChild(i.list)},50))},this.list.addEventListener("itemselected",function(e){i.setValue(e.detail)}),this.setValue=function(e,t){if(e===i.selectedValue||null!=e&&null!=i.selectedValue&&e.id==i.selectedValue.id)null!=i.selectedValue?i.input.value=i.html2text(i.selectedValue.html):i.input.value="";else{if(null!=e){if(null==e.html||null==e.id)throw new Error('Value must have fields "html" and "id".');i.selectedValue=e,i.input.value=i.html2text(e.html)}else i.selectedValue=null,i.input.value=null;if(i.list.selectValue(e),t||void 0===t){var l=null;null!=e&&(l={html:e.html,id:e.id,rowIndex:e.rowIndex}),i.input.dispatchEvent(new CustomEvent("valuechange",{detail:l}))}}},this.getValue=function(){return null==this.selectedValue?null:{id:this.selectedValue.id,html:this.selectedValue.html}},this.getText=function(){return i.input.value},this.setSourceCallback=function(e){i.sourceCallback=e,i.fillItems&&i.search(!0)},this.setEmptyText=function(e){i.emptyText=e},this.showOrHideEmptyText=function(){0==i.list.tbody.rows.length?(i.list.messageBox.innerText=i.emptyText||"",i.list.messageBox.classList.add("show")):i.list.messageBox.classList.remove("show")},this.clear=function(){i.list.clear(),i.setValue(null)},this.destroy=function(){e.classList.remove("cb-livesearch"),e.removeEventListener("click",i.inputClickListener),e.removeEventListener("focus",i.inputFocusListener),e.removeEventListener("keydown",i.inputKeyDownListener),e.removeEventListener("keyup",i.inputKeyUpListener),CbLiveSearchInstances.remove(i)}}document.addEventListener("click",function(){hideAllCbLiveSearch()});
